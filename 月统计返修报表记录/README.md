# 三江产品返修数据统计系统

## 项目概述

本项目旨在通过自动化流程处理物料信息与返修数据，实现从 Excel 数据导入到 MySQL 数据库存储，并最终生成规范化的返修统计报表。系统支持数据清洗、有效性校验及多维度统计分析，帮助用户高效管理产品返修记录并快速获取关键指标。

## 功能特点

1. **物料数据管理**
   - 从 Excel 指定工作表读取物料代码、物料描述及单板料号
   - 自动创建物料信息表（`material_stats`）并批量插入数据
   - 支持主键唯一性校验（避免物料代码重复）
2. **返修数据管理**
   - 从 Excel 提取返修记录（含数量、年份、月份、单板料号）
   - 自动创建返修数据表（`repair_stats`）并执行数据清洗（过滤空值、无效数值、非关联单板料号）
   - 仅保留与物料表中`board_code`匹配的有效数据
3. **报表生成**
   - 合并物料与返修数据，生成 2023 年及以后的月度数据透视表
   - 自动添加累计行并按时间排序月份列
   - 报表导出至桌面，文件名含时间戳（避免重复覆盖）

## 环境要求

- **操作系统**：Windows 10/11（兼容 Linux/macOS 需修改桌面路径获取逻辑）

- **Python 版本**：3.7 及以上

- **数据库**：MySQL 5.7 及以上

- 依赖库

  ：

  - `pandas>=1.3.0`（数据处理与 Excel 读写）
  - `pymysql>=1.0.2`（MySQL 数据库连接）
  - `openpyxl>=3.0.9`（Excel 文件解析支持）

## 安装与配置

### 1. 项目获取

bash

```bash
# 克隆仓库（若使用版本控制）
git clone <https://github.com/haodehaode378/shixi>
cd <月统计返修报表记录>
```

### 2. 依赖安装

通过`requirements.txt`安装所需库：

bash

```bash
pip install -r requirements.txt
```

### 3. 配置文件修改

编辑`config.py`配置数据库连接及 Excel 路径（**必做步骤**）：

python

```python
# 数据库配置（需替换为实际环境信息）
DB_CONFIG = {
    "host": "localhost",       # 数据库主机地址
    "user": "root",            # 数据库用户名
    "password": "123456",      # 数据库密码（替换为实际密码）
    "database": "三江",        # 数据库名称（需提前创建）
    "material_table": "material_stats",  # 物料表名（默认无需修改）
    "repair_table": "repair_stats"       # 返修表名（默认无需修改）
}

# Excel文件配置（需替换为实际文件路径）
EXCEL_CONFIG = {
    "path": r"C:\Users\admin\Desktop\三江\核心产品返修率-20250611外发wqt.xlsx",  # Excel文件绝对路径
    "material_sheet": "改善统计",  # 物料数据所在工作表名
    "repair_sheet": "返修"         # 返修数据所在工作表名
}
```

**注意**：

- 需提前在 MySQL 中创建名为`三江`的数据库（或修改`database`字段为现有库名）
- Excel 文件路径需使用绝对路径，确保文件存在且格式正确

## 使用流程

### 步骤 1：导入物料数据

运行物料数据入库脚本，从 Excel 读取并存储物料信息：

bash

```bash
python 入库物料代码和物料描述和转换代码.py
```

- 脚本会自动创建`material_stats`表（若不存在）

- 读取 Excel 中`改善统计`工作表的 A-C 列（第 1-13 行）

- 输出日志示例：

  plaintext

  ```plaintext
  数据库连接成功
  表 `material_stats` 已创建（若不存在）
  读取并映射后的物料数据：
    material_code  material_desc board_code
  0      ABC123     主板组件A       BD001
  ...
  成功插入 13 条物料数据
  数据库连接已关闭
  ```

### 步骤 2：导入返修数据

运行返修数据入库脚本，处理并存储返修记录：

bash

```bash
python 入库返修数据.py
```

- 脚本会自动创建`repair_stats`表（若不存在）

- 从物料表获取有效`board_code`列表，仅保留匹配的返修数据

- 数据清洗流程：过滤空值→清洗`board_code`→转换数值类型→匹配物料表

- 输出日志示例：

  plaintext

  ```plaintext
  数据库连接成功
  表 `repair_stats` 已创建（若不存在）
  从物料表获取到13个有效board_code
  读取到返修数据共100行
  过滤空值后剩余95行
  过滤空board_code后剩余90行
  过滤无效数值后剩余85行
  匹配物料表后剩余80行有效数据
  成功插入80条数据到repair_stats表
  数据库连接已关闭
  ```

### 步骤 3：生成统计报表

运行报表生成脚本，导出 2023 年及以后的返修统计报表：

bash

```bash
python 输出数据.py
```

- 报表格式：以物料代码、描述、单板料号为索引，月度数据为列，含累计行

- 报表位置：Windows 桌面，文件名为`返修统计_2023及以后_20250731_153022.xlsx`（含时间戳）

- 输出日志示例：

  plaintext

  ```plaintext
  数据库连接成功
  报表已保存至桌面：
  C:\Users\admin\Desktop\返修统计_2023及以后_20250731_153022.xlsx
  ```

## 文件说明

| 文件名                                | 功能描述                                           |
| ------------------------------------- | -------------------------------------------------- |
| `config.py`                           | 项目配置中心，存储数据库连接参数、Excel 路径及表名 |
| `db_utils.py`                         | 数据库工具类，提供连接创建与关闭功能               |
| `入库物料代码和物料描述和转换代码.py` | 物料数据处理脚本，负责创建物料表并导入数据         |
| `入库返修数据.py`                     | 返修数据处理脚本，负责创建返修表、数据清洗及导入   |
| `输出数据.py`                         | 报表生成脚本，从数据库读取数据并导出 Excel 报表    |
| `requirements.txt`                    | 项目依赖清单，用于安装所需 Python 库               |

## 常见问题

1. **数据库连接失败**
   - 检查`config.py`中数据库`host`、`user`、`password`是否正确
   - 确保 MySQL 服务已启动，且用户有权限访问目标数据库
2. **Excel 读取失败**
   - 确认`EXCEL_CONFIG["path"]`路径正确，文件未被占用
   - 检查工作表名（`material_sheet`/`repair_sheet`）是否与 Excel 一致
   - 确保 Excel 格式为`.xlsx`（不支持`.xls`，需转换格式）
3. **物料数据插入失败（主键重复）**
   - `material_code`为唯一主键，若 Excel 中存在重复值，需先去重
   - 可删除表中现有数据后重新插入：`TRUNCATE TABLE material_stats;`
4. **报表无数据**
   - 检查物料表与返修表是否有数据（可通过 MySQL 客户端查询）
   - 确认返修数据中存在 2023 年及以后的记录（`year >= 2023`）

## 联系方式

- 作者：王沁桐
- 邮箱：3636617336@qq.com
- 版本：v1.0（2025.07.31）